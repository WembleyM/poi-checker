<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0ea5e9"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî POI (2–ì–ò–°)</title>
  <style>
    :root { color-scheme: light; --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --text:#0f172a;
            --green:#dcfce7; --red:#fee2e2; --yellow:#fef3c7; --border:#e2e8f0; --primary:#0284c7; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
           background:var(--bg); color:var(--text); }
    .container { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; }
    .row { display:flex; gap:12px; align-items:center; }
    h1 { font-size: 20px; margin:0 0 4px 0; }
    .muted { color:var(--muted); font-size:14px; }
    input[type="text"], textarea, select { width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; font-size:14px; background:#f8fafc; color:var(--text); }
    textarea { height:180px; font-family: ui-monospace, monospace; }
    .btn { border:none; border-radius:12px; padding:10px 14px; font-size:14px; cursor:pointer; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:#eef2f7; color:var(--text); border:1px solid var(--border); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns:1fr 1fr; }
    .chip { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; }
    .results .item { display:flex; gap:12px; align-items:center; padding:10px 12px; }
    .results .ok { background: var(--green); }
    .results .bad { background: var(--red); }
    .results .error { background: var(--yellow); }
    .small { font-size:12px; }
    .header { display:flex; gap:12px; align-items:center; }
    .header .icon { width:32px; height:32px; border-radius:12px; background:#e2e8f0; display:flex; align-items:center; justify-content:center; }
    .topbar { display:flex; justify-content:space-between; align-items:center; }
    .ticks { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); }
    .spacer { height:8px; }
    .divider { height:1px; background:var(--border); margin:8px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="icon">üìç</div>
      <div>
        <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (2–ì–ò–°)</h1>
        <div class="muted">–†–∞–¥–∏—É—Å: <b id="hdrRadius">50</b> –º ‚Ä¢ –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API</div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="topbar">
        <div class="row"><strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong></div>
        <button class="btn btn-ghost" id="installBtn" style="display:none;">üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </div>

<div class="spacer"></div>

<!-- –§–æ—Ç–æ -> –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (OCR) -->
<div class="card">
  <div class="row">
    <strong>–§–æ—Ç–æ ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (OCR)</strong>
  </div>
  <div class="small muted">
    –ó–∞–≥—Ä—É–∑–∏—Ç–µ 50‚Äì100 —Ñ–æ—Ç–æ. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –¥–æ–±–∞–≤–∏—Ç –∏—Ö –≤ —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å.
  </div>
  <div class="spacer"></div>
  <div class="grid">
    <input id="photosInput" type="file" accept="image/*" multiple />
    <div class="row" style="gap:8px; flex-wrap:wrap;">
      <button class="btn btn-primary" id="ocrStartBtn">üì∑ –°—á–∏—Ç–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
      <button class="btn btn-ghost" id="ocrClearBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã OCR</button>
    </div>
    <div id="ocrProgress" class="small muted" style="display:none;">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶</div>
    <div id="ocrFound" class="small"></div>
  </div>
</div>
      
                                                     

      <div class="grid">
        <div>
          <label>–†–∞–¥–∏—É—Å</label>
          <input type="range" id="radiusSlider" min="0" max="3" step="1" value="2"/>
          <div class="ticks"><span>10–º</span><span>25–º</span><span><b>50–º</b></span><span>100–º</span></div>
        </div>

        <div>
          <div class="small muted">–¢–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤:</div>
          <div class="grid grid-2" id="cats"></div>
        </div>

        <!-- –ü—Ä–µ—Å–µ—Ç—ã: —Å–∫—Ä—ã—Ç—ã, –Ω–æ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω -->
        <div id="presetsCard" class="card" style="display:none;"></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <div class="row"><span>‚ÑπÔ∏è</span><div class="muted">–í–≤–æ–¥–∏—Ç–µ –ø–æ —Å—Ç—Ä–æ–∫–µ: <code>lat, lon</code>. –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <span id="parsedCount">0</span>/<span id="totalCount">0</span></div></div>
      <div class="spacer"></div>
      <textarea id="coords" placeholder="55.751244, 37.618423
55.760000, 37.620000"></textarea>
      <div class="spacer"></div>
      <div class="row" style="flex-wrap:wrap; gap:8px;">
        <button class="btn btn-primary" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn btn-ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-ghost" id="exportBtn" disabled>–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="card" id="resultsCard" style="display:none;">
      <div class="row"><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong></div>
      <div class="divider"></div>
      <div class="results" id="results"></div>
    </div>

    <div class="spacer"></div>
    <div class="small muted">
      PWA: Android ‚Äî ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª. iOS ‚Äî ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –¥–æ–º–æ–π¬ª.
    </div>
  </div>

<script>
(() => {
  const DGIS_API_KEY = '29be9032-3273-4d3c-88a4-6064edb8d02b';
  const RADIUS_STEPS = [10, 25, 50, 100];
  const DEFAULT_CATEGORIES = [
    { key: 'school', label:'–®–∫–æ–ª—ã', queries:['—à–∫–æ–ª–∞','–ª–∏—Ü–µ–π','–≥–∏–º–Ω–∞–∑–∏—è'] },
    { key: 'kindergarten', label:'–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã', queries:['–¥–µ—Ç—Å–∫–∏–π —Å–∞–¥','—è—Å–ª–∏'] },
    { key: 'police', label:'–ü–æ–ª–∏—Ü–∏—è', queries:['–ø–æ–ª–∏—Ü–∏—è','–æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏'] },
    { key: 'kids_club', label:'–î–µ—Ç—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏', queries:['–¥–µ—Ç—Å–∫–∞—è —Å–µ–∫—Ü–∏—è','–¥–µ—Ç—Å–∫–∏–π –∫—Ä—É–∂–æ–∫','–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±','–î–Æ–°–®'] },
    { key: 'court', label:'–°—É–¥—ã', queries:['—Å—É–¥','–º–∏—Ä–æ–≤–æ–π —Å—É–¥','—Ä–∞–π–æ–Ω–Ω—ã–π —Å—É–¥'] },
  ];

  const $ = (id) => document.getElementById(id);
  const toRad = (v) => (v * Math.PI) / 180;
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));
  const jitter = (base)=> Math.floor(base + Math.random()*base);

  const haversineMeters = (lat1, lon1, lat2, lon2) => {
    const R = 6371000;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  };

  const parsePoint = (line) => {
    if (!line) return null;
    let s = String(line).replace(/\u00A0/g," ").replace(/[¬∞]/g," ");
    s = s.replace(/(\d)\s*,\s*(?=\d)/g, "$1.");
    s = s.replace(/[;,]/g," ").replace(/\s+/g," ").trim();
    const nums = s.match(/-?\d+(?:\.\d+)?/g);
    if (!nums || nums.length < 2) return null;
    const a = parseFloat(nums[0]), b = parseFloat(nums[1]);
    if (!isFinite(a) || !isFinite(b)) return null;
    let lat, lon;
    if (Math.abs(a) > 90 && Math.abs(b) <= 90) { lon=a; lat=b; } else { lat=a; lon=b; }
    if (Math.abs(lat)>90 || Math.abs(lon)>180) return null;
    return { lat, lon };
  };

  async function query2gis(q, lat, lon, radius) {
    const ps = new URLSearchParams({
      q, type:'branch', key:DGIS_API_KEY,
      point:`${lon},${lat}`,
      radius:String(Math.min(Math.max(radius,1),3000)),
      page_size:'10',
      sort:'distance',
      fields:'items.point,items.rubrics,items.name',
    });
    const url = `https://catalog.api.2gis.com/3.0/items?${ps.toString()}`;
    const resp = await fetch(url);
    if (!resp.ok) {
      let detail = `HTTP ${resp.status}`;
      try { const err = await resp.json(); if (err?.error) detail += ' ‚Äî '+err.error; } catch{}
      throw new Error(detail);
    }
    return resp.json();
  }

  // –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
  function renderCats() {
    const wrap = $('cats'); wrap.innerHTML='';
    DEFAULT_CATEGORIES.forEach(cat => {
      const label = document.createElement('label');
      label.className = 'chip';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = true;
      input.onchange = () => {};
      const span = document.createElement('span'); span.textContent = cat.label;
      label.append(input, span);
      wrap.appendChild(label);
    });
  }

  function updateCounts() {
    const lines = $('coords').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    $('totalCount').textContent = String(lines.length);
    const parsed = lines.reduce((acc, l)=> acc + (parsePoint(l)?1:0), 0);
    $('parsedCount').textContent = String(parsed);
  }

  function showResults(rows, radius) {
    const card = $('resultsCard');
    const wrap = $('results'); wrap.innerHTML = '';
    if (!rows.length) { card.style.display='none'; return; }
    card.style.display='block';
    rows.forEach(r => {
      const d = document.createElement('div');
      d.className = `item ${r.status}`;
      const icon = r.status==='ok' ? '‚úÖ' : (r.status==='bad' ? '‚ùå' : '‚ö†Ô∏è');
      const line = document.createElement('div'); line.style.flex='1';
      line.innerHTML = `<div style="font-family:ui-monospace,monospace;font-size:13px">${r.line}</div>
        <div class="small">
          ${
            r.status==='ok'    ? (r.minDist!=null?`–ë–ª–∏–∂–∞–π—à–∏–π –æ–±—ä–µ–∫—Ç: ${Math.round(r.minDist)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}`:'–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≤—Å—ë –æ–∫') :
            r.status==='bad'   ? `–û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç –±–ª–∏–∂–µ ${radius} –º: ${Math.round(r.minDist||0)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}` :
            r.details ? r.details : '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'
          }
        </div>`;
      const iconBox = document.createElement('div'); iconBox.style.width='24px'; iconBox.textContent = icon;
      d.append(iconBox, line);
      wrap.appendChild(d);
    });
    $('exportBtn').disabled = rows.length===0;
  }

  async function checkPoints() {
    const lines = $('coords').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const results = [];
    const radius = RADIUS_STEPS[parseInt($('radiusSlider').value,10)] || 50;
    $('hdrRadius').textContent = radius;

    $('checkBtn').disabled = true;
    $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶';

    try {
      for (let i=0; i<lines.length; i++) {
        const raw = lines[i];
        const pt = parsePoint(raw);
        if (!pt) { results.push({ index:i, line:raw, status:'error', details:'–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã' }); continue; }
        const { lat, lon } = pt;

        let minDist = Infinity; let nearest;
        let lastHttpError = null;

        for (const cat of DEFAULT_CATEGORIES) {
          for (const q of cat.queries) {
            try {
              const data = await query2gis(q, lat, lon, radius);
              const items = data?.result?.items || [];
              for (const it of items) {
                const p = it?.point; const ilon = p?.lon; const ilat = p?.lat;
                if (ilat==null || ilon==null) continue;
                const d = haversineMeters(lat, lon, ilat, ilon);
                if (d < minDist) {
                  minDist = d;
                  const name = it?.name;
                  const rubric = it?.rubrics && it.rubrics[0]?.name;
                  nearest = name ? (name + (rubric ? ` (${rubric})` : '')) : undefined;
                }
              }
            } catch (e) {
              lastHttpError = e.message;
            }
            if (minDist <= radius) break;
          }
          if (minDist <= radius) break;
        }

        if (!isFinite(minDist)) {
          if (lastHttpError) results.push({ index:i, line:raw, status:'error', details:lastHttpError });
          else results.push({ index:i, line:raw, status:'ok' });
        } else if (minDist <= radius) {
          results.push({ index:i, line:raw, status:'bad', nearest, minDist });
        } else {
          results.push({ index:i, line:raw, status:'ok', nearest, minDist });
        }
      }
    } finally {
      $('checkBtn').disabled = false;
      $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
    }

    results.sort((a,b)=>a.index-b.index);
    showResults(results, radius);
  }

  function exportCSV(rows) {
    if (!rows.length) return;
    const header = 'index,line,status,minDist,nearest\n';
    const body = rows.map(r => [
      r.index,
      '"' + String(r.line).replace(/"/g,'""') + '"',
      r.status,
      r.minDist ?? '',
      r.nearest ? '"' + String(r.nearest).replace(/"/g,'""') + '"' : ''
    ].join(',')).join('\n');
    const csv = header + body;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'poi_results.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // —Å–æ–±—ã—Ç–∏—è
  $('coords').addEventListener('input', updateCounts);
  $('checkBtn').addEventListener('click', checkPoints);
  $('clearBtn').addEventListener('click', () => { $('coords').value=''; updateCounts(); showResults([]); });
  $('exportBtn').addEventListener('click', () => exportCSV([]));

  $('radiusSlider').addEventListener('input', (e) => {
    const idx = parseInt(e.target.value, 10);
    const r = RADIUS_STEPS[idx] ?? 50;
    $('hdrRadius').textContent = r;
  });

  // init
  renderCats();
  updateCounts();

  <script>
// ==== OCR: —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Tesseract.js) ====
// –í—Å—Ç–∞–≤–∏—Ç—å –≤–Ω—É—Ç—Ä—å —Ç–≤–æ–µ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ <script>, –≤–º–µ—Å—Ç–µ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º –≤–µ—Ä—Å–∏–∏ 1.0

// –†–µ–≥—É–ª—è—Ä–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
const COORD_PATTERNS = [
  // 55.12345, 37.12345  |  -55.1  ,  -37.2
  /(-?\d{1,3}(?:[.,]\d+))\s*[,;\s]\s*(-?\d{1,3}(?:[.,]\d+))/g,
  // lat: 55.123; lon: 37.123  | —à–∏—Ä–æ—Ç–∞ 55.1 –¥–æ–ª–≥–æ—Ç–∞ 37.2
  /(lat|—à–∏—Ä–æ—Ç–∞)[^\d\-]*(-?\d{1,3}(?:[.,]\d+)).{0,15}(lon|long|–¥–æ–ª–≥–æ—Ç–∞)[^\d\-]*(-?\d{1,3}(?:[.,]\d+))/gi,
  // N55.123 E37.123  |  S55.0 W37.0
  /\b([NS])\s*(\d{1,3}(?:[.,]\d+)?)\s*[,\s;]\s*([EW])\s*(\d{1,3}(?:[.,]\d+)?)/gi,
];

// –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—ã (lat, lon) –∏–∑ –ª—é–±—ã—Ö –º–∞—Ç—á–µ–π
function normalizePair(a, b) {
  const toNum = (s)=> parseFloat(String(s).replace(',', '.'));
  let lat = toNum(a), lon = toNum(b);
  // –µ—Å–ª–∏ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω—ã –º–µ—Å—Ç–∞–º–∏ (lon —è–≤–Ω–æ >90 –ø–æ –º–æ–¥—É–ª—é)
  if (Math.abs(lat) > 90 && Math.abs(lon) <= 90) [lat, lon] = [lon, lat];
  if (!isFinite(lat) || !isFinite(lon) || Math.abs(lat) > 90 || Math.abs(lon) > 180) return null;
  return { lat, lon };
}

// –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏–∑ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ OCR
function extractCoordsFromText(text) {
  const found = [];

  // –ø–∞—Ç—Ç–µ—Ä–Ω 1: "55.123, 37.123"
  let m;
  const p1 = new RegExp(COORD_PATTERNS[0]); p1.lastIndex = 0;
  while ((m = p1.exec(text)) !== null) {
    const pair = normalizePair(m[1], m[2]);
    if (pair) found.push(pair);
  }

  // –ø–∞—Ç—Ç–µ—Ä–Ω 2: "lat: 55.1 ... lon: 37.2" (–≤ –ª—é–±–æ–º –ø–æ—Ä—è–¥–∫–µ, —É—á–∏—Ç—ã–≤–∞–µ–º —Ä—É—Å/–∞–Ω–≥–ª)
  const p2 = new RegExp(COORD_PATTERNS[1]);
  p2.lastIndex = 0;
  while ((m = p2.exec(text)) !== null) {
    const pair = normalizePair(m[2], m[4]);
    if (pair) found.push(pair);
  }

  // –ø–∞—Ç—Ç–µ—Ä–Ω 3: "N55.1 E37.2"
  const p3 = new RegExp(COORD_PATTERNS[2]);
  p3.lastIndex = 0;
  while ((m = p3.exec(text)) !== null) {
    const signLat = m[1].toUpperCase()==='S' ? -1 : 1;
    const signLon = m[3].toUpperCase()==='W' ? -1 : 1;
    const lat = signLat * parseFloat(String(m[2]).replace(',', '.'));
    const lon = signLon * parseFloat(String(m[4]).replace(',', '.'));
    const pair = normalizePair(lat, lon);
    if (pair) found.push(pair);
  }

  return found;
}

// –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø–æ ¬´—è—á–µ–π–∫–µ¬ª ~5‚Äì6 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
function dedupePoints(points, precision = 6) {
  const key = (p)=> `${p.lat.toFixed(precision)},${p.lon.toFixed(precision)}`;
  const map = new Map();
  for (const p of points) map.set(key(p), p);
  return Array.from(map.values());
}

// OCR: –ø—Ä–æ–≥–Ω–∞—Ç—å –ø–∞—á–∫—É —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ Tesseract
async function ocrExtractCoordsFromFiles(files) {
  const progressEl = document.getElementById('ocrProgress');
  const foundEl = document.getElementById('ocrFound');

  if (!files || !files.length) {
    foundEl.textContent = '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã.';
    return [];
  }

  foundEl.textContent = '';
  progressEl.style.display = 'block';
  progressEl.textContent = `–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞‚Ä¶ (0 / ${files.length})`;

  // Tesseract —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏: —è–∑—ã–∫ 'eng+rus', —Ä–µ–∂–∏–º LSTM
  const worker = await Tesseract.createWorker('eng+rus', 1, {
    // logger: m => console.log(m), // –≤–∫–ª—é—á–∏ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ
  });

  const results = [];
  try {
    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      // —á–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ dataURL
      const dataURL = await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });

      progressEl.textContent = `–†–∞—Å–ø–æ–∑–Ω–∞—é ${i+1} / ${files.length} ‚Äî ${file.name}`;

      // OCR
      const { data } = await worker.recognize(dataURL, { rotateAuto: true });
      const text = data?.text || '';

      // –ü–∞—Ä—Å–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
      const pts = extractCoordsFromText(text);
      if (pts.length) {
        results.push(...pts);
        const sample = pts.map(p => `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}`).join(' ¬∑ ');
        foundEl.innerHTML += `<div>‚úÖ ${file.name}: ${sample}</div>`;
      } else {
        foundEl.innerHTML += `<div>‚ö†Ô∏è ${file.name}: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>`;
      }
    }
  } finally {
    await worker.terminate();
    progressEl.style.display = 'none';
  }

  return dedupePoints(results, 6);
}

// –í—Å—Ç–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–æ—á–∫–∏ –≤ textarea
function appendPointsToTextarea(points) {
  if (!points.length) return;
  const ta = document.getElementById('coords');
  const existing = ta.value.trim();
  const lines = points.map(p => `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}`).join('\n');
  ta.value = existing ? (existing + '\n' + lines) : lines;
  // –æ–±–Ω–æ–≤–∏–º —Å—á–µ—Ç—á–∏–∫–∏
  const evt = new Event('input'); ta.dispatchEvent(evt);
}

// –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI OCR
(function initOCRUI(){
  const input = document.getElementById('photosInput');
  const btnStart = document.getElementById('ocrStartBtn');
  const btnClear = document.getElementById('ocrClearBtn');
  const foundEl = document.getElementById('ocrFound');

  btnStart?.addEventListener('click', async () => {
    if (!input.files || !input.files.length) {
      foundEl.textContent = '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ç–æ.';
      return;
    }
    btnStart.disabled = true;
    btnStart.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞—é‚Ä¶';
    try {
      const points = await ocrExtractCoordsFromFiles(input.files);
      if (!points.length) {
        foundEl.innerHTML += `<div class="small muted">–ì–æ—Ç–æ–≤–æ. –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã.</div>`;
      } else {
        appendPointsToTextarea(points);
        foundEl.innerHTML += `<div class="small">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫: ${points.length} —Ç–æ—á–µ–∫</div>`;
      }
    } catch(e) {
      foundEl.innerHTML += `<div>–û—à–∏–±–∫–∞ OCR: ${String(e?.message || e)}</div>`;
    } finally {
      btnStart.disabled = false;
      btnStart.textContent = 'üì∑ –°—á–∏—Ç–∞—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã';
    }
  });

  btnClear?.addEventListener('click', () => {
    const input = document.getElementById('photosInput');
    const progress = document.getElementById('ocrProgress');
    const found = document.getElementById('ocrFound');
    if (input) input.value = '';
    if (progress) { progress.style.display = 'none'; progress.textContent = ''; }
    if (found) found.textContent = '';
  });
})();
</script>

})();
</script>

</body>
</html>
