<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0ea5e9"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî POI (2–ì–ò–°, –±–µ–∑ –ø—Ä–æ–∫—Å–∏)</title>
  <style>
    :root { color-scheme: light; --bg:#f8fafc; --card:#ffffff; --muted:#64748b; --text:#0f172a;
            --green:#dcfce7; --red:#fee2e2; --yellow:#fef3c7; --border:#e2e8f0; --primary:#0284c7; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
           background:var(--bg); color:var(--text); }
    .container { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; }
    .row { display:flex; gap:12px; align-items:center; }
    h1 { font-size: 20px; margin:0 0 4px 0; }
    .muted { color:var(--muted); font-size:14px; }
    label { font-size:14px; }
    input[type="text"], textarea, select { width:100%; padding:10px 12px; border:1px solid var(--border);
      border-radius:12px; font-size:14px; background:#f8fafc; color:var(--text); }
    textarea { height:180px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .btn { border:none; border-radius:12px; padding:10px 14px; font-size:14px; cursor:pointer; }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-ghost { background:#eef2f7; color:var(--text); border:1px solid var(--border); }
    .grid { display:grid; gap:12px; }
    .grid-2 { grid-template-columns:1fr 1fr; }
    .chip { display:flex; align-items:center; gap:8px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; }
    .results .item { display:flex; gap:12px; align-items:center; padding:10px 12px; }
    .results .ok { background: var(--green); }
    .results .bad { background: var(--red); }
    .results .error { background: var(--yellow); }
    .small { font-size:12px; }
    .header { display:flex; gap:12px; align-items:center; }
    .header .icon { width:32px; height:32px; border-radius:12px; background:#e2e8f0; display:flex; align-items:center; justify-content:center; }
    .topbar { display:flex; justify-content:space-between; align-items:center; }
    .ticks { display:flex; justify-content:space-between; font-size:12px; color:var(--muted); }
    .spacer { height:8px; }
    .divider { height:1px; background:var(--border); margin:8px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="icon">üìç</div>
      <div>
        <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç (2–ì–ò–°)</h1>
        <div class="muted">–†–∞–¥–∏—É—Å: <b id="hdrRadius">50</b> –º ‚Ä¢ –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ API (–∫–ª—é—á –≤—à–∏—Ç)</div>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="card">
      <div class="topbar">
        <div class="row"><strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</strong></div>
        <button class="btn btn-ghost" id="installBtn" style="display:none;">üì≤ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      </div>

      <div class="grid">
        <div>
          <label>–†–∞–¥–∏—É—Å</label>
          <input type="range" id="radiusSlider" min="0" max="3" step="1" value="2"/>
          <div class="ticks"><span>10–º</span><span>25–º</span><span><b>50–º</b></span><span>100–º</span></div>
        </div>

        <div>
          <div class="small muted">–¢–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤:</div>
          <div class="grid grid-2" id="cats"></div>
        </div>

        <div class="card" style="background:#f8fafc;">
          <div class="row"><strong>–ü—Ä–µ—Å–µ—Ç—ã</strong></div>
          <div class="grid">
            <div class="row" style="gap:8px;">
              <input type="text" id="presetName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" />
              <button class="btn btn-primary" id="savePreset">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            <div class="row" style="gap:8px;">
              <select id="presetSelect"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option></select>
              <button class="btn btn-ghost" id="deletePreset">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- –í–≤–æ–¥ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
    <div class="card">
      <div class="row"><span>‚ÑπÔ∏è</span><div class="muted">–í–≤–æ–¥–∏—Ç–µ –ø–æ —Å—Ç—Ä–æ–∫–µ: <code>lat, lon</code>. –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <span id="parsedCount">0</span>/<span id="totalCount">0</span></div></div>
      <div class="spacer"></div>
      <textarea id="coords" placeholder="55.751244, 37.618423
55.760000, 37.620000"></textarea>
      <div class="spacer"></div>
      <div class="row" style="flex-wrap:wrap; gap:8px;">
        <button class="btn btn-primary" id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn btn-ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-ghost" id="exportBtn" disabled>–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      </div>
    </div>

    <div class="spacer"></div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
    <div class="card" id="resultsCard" style="display:none;">
      <div class="row"><strong>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</strong></div>
      <div class="divider"></div>
      <div class="results" id="results"></div>
    </div>

    <div class="spacer"></div>
    <div class="small muted">
      PWA: Android ‚Äî ¬´–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å¬ª. iOS ‚Äî ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è¬ª ‚Üí ¬´–ù–∞ —ç–∫—Ä–∞–Ω –¥–æ–º–æ–π¬ª.
    </div>
  </div>

<script>
(() => {
  // ---- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ----
  const DGIS_API_KEY = '29be9032-3273-4d3c-88a4-6064edb8d02b'; // <= –¢–í–û–ô –ö–õ–Æ–ß 2–ì–ò–° (–≤–∏–¥–µ–Ω –≤–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ)
  const RADIUS_STEPS = [10, 25, 50, 100];
  const DEFAULT_CATEGORIES = [
    { key: 'school',       label:'–®–∫–æ–ª—ã',         queries:['—à–∫–æ–ª–∞','–ª–∏—Ü–µ–π','–≥–∏–º–Ω–∞–∑–∏—è'] },
    { key: 'kindergarten', label:'–î–µ—Ç—Å–∫–∏–µ —Å–∞–¥—ã',  queries:['–¥–µ—Ç—Å–∫–∏–π —Å–∞–¥','—è—Å–ª–∏'] },
    { key: 'police',       label:'–ü–æ–ª–∏—Ü–∏—è',       queries:['–ø–æ–ª–∏—Ü–∏—è','–æ—Ç–¥–µ–ª –ø–æ–ª–∏—Ü–∏–∏'] },
    { key: 'kids_club',    label:'–î–µ—Ç—Å–∫–∏–µ —Å–µ–∫—Ü–∏–∏',queries:['–¥–µ—Ç—Å–∫–∞—è —Å–µ–∫—Ü–∏—è','–¥–µ—Ç—Å–∫–∏–π –∫—Ä—É–∂–æ–∫','–¥–µ—Ç—Å–∫–∏–π –∫–ª—É–±','–î–Æ–°–®'] },
    { key: 'court',        label:'–°—É–¥—ã',          queries:['—Å—É–¥','–º–∏—Ä–æ–≤–æ–π —Å—É–¥','—Ä–∞–π–æ–Ω–Ω—ã–π —Å—É–¥'] },
  ];

  const LS_CATS   = 'poi_categories';
  const LS_RADIUS = 'poi_radius';
  const LS_PRESETS= 'poi_presets';

  let enabledKeys = [...DEFAULT_CATEGORIES.map(c => c.key)];
  let radius = 50;
  let presets = [];
  let rows = [];

  // ---- –£—Ç–∏–ª–∏—Ç—ã ----
  const $ = (id) => document.getElementById(id);
  const toRad = (v) => (v * Math.PI) / 180;
  const sleep = (ms)=> new Promise(r=>setTimeout(r, ms));

  const haversineMeters = (lat1, lon1, lat2, lon2) => {
    const R = 6371000;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  };

  // –ù–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Å–µ—Ä "55.12345, 37.12345" (+ –≤–∞—Ä–∏–∞—Ü–∏–∏)
  const parsePoint = (line) => {
    if (!line) return null;
    let s = String(line).replace(/\u00A0/g, " ").replace(/[¬∞]/g, " ");
    s = s.replace(/(\d)\s*,\s*(?=\d)/g, "$1."); // –¥–µ—Å—è—Ç–∏—á–Ω–∞—è –∑–∞–ø—è—Ç–∞—è -> —Ç–æ—á–∫–∞
    s = s.replace(/[;,]/g, " ").replace(/\s+/g, " ").trim();
    const nums = s.match(/-?\d+(?:\.\d+)?/g);
    if (!nums || nums.length < 2) return null;
    const a = parseFloat(nums[0]), b = parseFloat(nums[1]);
    if (!isFinite(a) || !isFinite(b)) return null;
    let lat, lon;
    if (Math.abs(a) > 90 && Math.abs(b) <= 90) { lon=a; lat=b; } else { lat=a; lon=b; }
    if (Math.abs(lat)>90 || Math.abs(lon)>180) return null;
    return { lat, lon };
  };

  function renderCats() {
    const wrap = $('cats'); wrap.innerHTML = '';
    DEFAULT_CATEGORIES.forEach(cat => {
      const label = document.createElement('label');
      label.className = 'chip';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = enabledKeys.includes(cat.key);
      input.onchange = () => {
        if (input.checked) enabledKeys = [...enabledKeys, cat.key];
        else enabledKeys = enabledKeys.filter(k => k !== cat.key);
        localStorage.setItem(LS_CATS, JSON.stringify(enabledKeys));
      };
      const span = document.createElement('span'); span.textContent = cat.label;
      label.append(input, span);
      wrap.appendChild(label);
    });
  }

  function loadFromStorage() {
    const cats = localStorage.getItem(LS_CATS);
    if (cats) { try { enabledKeys = JSON.parse(cats); } catch{} }
    const rad = localStorage.getItem(LS_RADIUS);
    if (rad) radius = parseInt(rad,10) || 50;
    const pr = localStorage.getItem(LS_PRESETS);
    if (pr) { try { presets = JSON.parse(pr); } catch{} }
  }

  function renderPresetSelect() {
    const sel = $('presetSelect');
    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ‚Ä¶</option>';
    presets.forEach(p => {
      const o = document.createElement('option');
      o.value = p.name; o.textContent = `${p.name} ‚Äî ${p.radius}–º`;
      sel.appendChild(o);
    });
  }

  function setRadius(r) {
    radius = r;
    localStorage.setItem(LS_RADIUS, String(r));
    $('hdrRadius').textContent = String(r);
  }

  function updateCounts() {
    const lines = $('coords').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    $('totalCount').textContent = String(lines.length);
    const parsed = lines.reduce((acc, l)=> acc + (parsePoint(l)?1:0), 0);
    $('parsedCount').textContent = String(parsed);
  }

  function showResults(list) {
    rows = list.slice();
    const card = $('resultsCard');
    const wrap = $('results'); wrap.innerHTML = '';
    if (!rows.length) { card.style.display='none'; return; }
    card.style.display='block';
    rows.forEach(r => {
      const d = document.createElement('div');
      d.className = `item ${r.status}`;
      const icon = r.status==='ok' ? '‚úÖ' : (r.status==='bad' ? '‚ùå' : '‚ö†Ô∏è');
      const line = document.createElement('div'); line.style.flex='1';
      line.innerHTML = `<div style="font-family:ui-monospace,monospace;font-size:13px">${r.line}</div>
        <div class="small">
          ${
            r.status==='ok'    ? (r.minDist!=null?`–ë–ª–∏–∂–∞–π—à–∏–π –æ–±—ä–µ–∫—Ç: ${Math.round(r.minDist)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}`:'–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≤—Å—ë –æ–∫') :
            r.status==='bad'   ? `–û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç –±–ª–∏–∂–µ ${radius} –º: ${Math.round(r.minDist||0)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}` :
            r.details ? r.details : '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'
          }
        </div>`;
      const iconBox = document.createElement('div'); iconBox.style.width='24px'; iconBox.textContent = icon;
      d.append(iconBox, line);
      wrap.appendChild(d);
    });
    $('exportBtn').disabled = rows.length===0;
  }

  // ---- –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–Ω–∞–ø—Ä—è–º—É—é –≤ 2–ì–ò–°) ----
  async function query2gis(q, lat, lon, radius, pageSize=10) {
    // –°—Ç—Ä–æ–∏–º URL 2–ì–ò–°: –∫–∞—Ç–∞–ª–æ–≥, —Ç–æ—á–∫–∞, —Ä–∞–¥–∏—É—Å, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏, –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
    const ps = new URLSearchParams({
      q,
      type: 'branch',
      key: DGIS_API_KEY,
      point: `${lon},${lat}`,          // 2–ì–ò–° –æ–∂–∏–¥–∞–µ—Ç "lon,lat"
      radius: String(Math.min(Math.max(radius,1),3000)),
      page_size: String(Math.min(Math.max(pageSize,1),10)), // –Ω–∞ –º–Ω–æ–≥–∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ <=10
      sort: 'distance',
      fields: 'items.point,items.rubrics,items.name',
    });
    const url = `https://catalog.api.2gis.com/3.0/items?${ps.toString()}`;
    const resp = await fetch(url);
    if (!resp.ok) {
      let detail = `HTTP ${resp.status}`;
      try { const err = await resp.json(); if (err?.error) detail += ` ‚Äî ${err.error}`; } catch {}
      const e = new Error(detail);
      e.isHttp = true;
      throw e;
    }
    return resp.json(); // { result: { items: [...] } }
  }

  async function checkPoints() {
    const lines = $('coords').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const results = [];
    $('checkBtn').disabled = true;
    $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶';

    try {
      for (let i=0; i<lines.length; i++) {
        const raw = lines[i];
        const pt = parsePoint(raw);
        if (!pt) { results.push({ index:i, line:raw, status:'error', details:'–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã' }); continue; }
        const { lat, lon } = pt;

        let minDist = Infinity; let nearest;
        let lastHttpError = null;

        const activeCats = DEFAULT_CATEGORIES.filter(c=>enabledKeys.includes(c.key));
        for (const cat of activeCats) {
          for (const q of cat.queries) {
            try {
              const data = await query2gis(q, lat, lon, radius, 10);
              const items = data?.result?.items || data?.items || [];
              // –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ: –ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –∞ –≤ –∏—Ç–æ–≥–µ —ç—Ç–æ OK
              for (const it of items) {
                const p = it?.point;
                const ilon = p?.lon;
                const ilat = p?.lat;
                if (ilat==null || ilon==null) continue;
                const d = haversineMeters(lat, lon, ilat, ilon);
                if (d < minDist) {
                  minDist = d;
                  const name = it?.name;
                  const rubric = it?.rubrics && it.rubrics[0]?.name;
                  nearest = name ? (name + (rubric ? ` (${rubric})` : '')) : undefined;
                }
              }
            } catch (e) {
              if (e?.isHttp) lastHttpError = e.message; // –Ω–∞–ø—Ä., HTTP 403/429
              else lastHttpError = 'NETWORK_ERROR';
            }

            // —â–∞–¥—è—â–∞—è –ø–∞—É–∑–∞ –ø–æ –ª–∏–º–∏—Ç–∞–º
            await sleep(60);

            if (minDist <= radius) break;
          }
          if (minDist <= radius) break;
        }

        // –†–µ—à–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä–æ–∫–µ:
        if (!isFinite(minDist)) {
          // –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî —ç—Ç–æ OK; –Ω–æ –µ—Å–ª–∏ –±—ã–ª–æ —è–≤–Ω–æ–µ HTTP/NETWORK, –ø–æ–∫–∞–∂–µ–º –∫–∞–∫ error
          if (lastHttpError) results.push({ index:i, line:raw, status:'error', details:lastHttpError });
          else results.push({ index:i, line:raw, status:'ok' });
        } else if (minDist <= radius) {
          results.push({ index:i, line:raw, status:'bad', nearest, minDist });
        } else {
          results.push({ index:i, line:raw, status:'ok', nearest, minDist });
        }
      }
    } finally {
      $('checkBtn').disabled = false;
      $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
    }

    results.sort((a,b)=>a.index-b.index);
    showResults(results);
  }

  // ---- –≠–∫—Å–ø–æ—Ä—Ç CSV ----
  function exportCSV() {
    if (!rows.length) return;
    const header = 'index,line,status,minDist,nearest\n';
    const body = rows.map(r => [
      r.index,
      `"${String(r.line).replaceAll('"','""')}"`,
      r.status,
      r.minDist ?? '',
      r.nearest ? `"${String(r.nearest).replaceAll('"','""')}"` : ''
    ].join(',')).join('\n');
    const csv = header + body;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'poi_results.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // ---- –ü—Ä–µ—Å–µ—Ç—ã ----
  function savePreset() {
    const name = $('presetName').value.trim(); if (!name) return;
    const preset = { name, radius, enabledKeys };
    presets = [...presets.filter(p=>p.name!==name), preset];
    localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
    renderPresetSelect();
    $('presetSelect').value = name;
    $('presetName').value = '';
  }
  function applyPreset() {
    const name = $('presetSelect').value;
    const p = presets.find(x=>x.name===name); if (!p) return;
    enabledKeys = p.enabledKeys.slice();
    setRadius(p.radius);
    $('radiusSlider').value = String(Math.max(0, RADIUS_STEPS.indexOf(p.radius)));
    renderCats();
  }
  function deletePreset() {
    const name = $('presetSelect').value; if (!name) return;
    presets = presets.filter(p=>p.name!==name);
    localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
    renderPresetSelect();
  }

  // ---- PWA –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ----
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $('installBtn').style.display = 'inline-block';
  });
  $('installBtn').addEventListener('click', async () => {
    if (deferredPrompt) { await deferredPrompt.prompt(); $('installBtn').style.display = 'none'; }
  });

  // ---- –°–ª—É—à–∞—Ç–µ–ª–∏ ----
  $('coords').addEventListener('input', updateCounts);
  $('checkBtn').addEventListener('click', checkPoints);
  $('clearBtn').addEventListener('click', () => { $('coords').value=''; updateCounts(); showResults([]); });
  $('exportBtn').addEventListener('click', exportCSV);
  $('savePreset').addEventListener('click', savePreset);
  $('presetSelect').addEventListener('change', applyPreset);
  $('deletePreset').addEventListener('click', deletePreset);

  $('radiusSlider').addEventListener('input', (e) => {
    const idx = parseInt(e.target.value, 10);
    const r = RADIUS_STEPS[idx] ?? 50;
    setRadius(r);
  });

  // ---- –°—Ç–∞—Ä—Ç ----
  loadFromStorage();
  renderCats();
  renderPresetSelect();
  const idx = Math.max(0, RADIUS_STEPS.indexOf(radius));
  $('radiusSlider').value = String(idx);
  setRadius(radius);
  updateCounts();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }
})();
</script>
</body>
</html>
ap = $('results'); wrap.innerHTML = '';
    if (!rows.length) { card.style.display='none'; return; }
    card.style.display='block';
    rows.forEach(r => {
      const d = document.createElement('div');
      d.className = `item ${r.status}`;
      const icon = r.status==='ok' ? '‚úÖ' : (r.status==='bad' ? '‚ùå' : '‚ö†Ô∏è');
      const line = document.createElement('div'); line.style.flex='1';
      line.innerHTML = `<div style="font-family:ui-monospace,monospace;font-size:13px">${r.line}</div>
        <div class="small">
          ${
            r.status==='ok'    ? (r.minDist!=null?`–ë–ª–∏–∂–∞–π—à–∏–π –æ–±—ä–µ–∫—Ç: ${Math.round(r.minDist)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}`:'–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –≤—Å—ë –æ–∫') :
            r.status==='bad'   ? `–û–±–Ω–∞—Ä—É–∂–µ–Ω –æ–±—ä–µ–∫—Ç –±–ª–∏–∂–µ ${radius} –º: ${Math.round(r.minDist||0)} –º${r.nearest?` ‚Äî ${r.nearest}`:''}` :
            r.details ? r.details : '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'
          }
        </div>`;
      const iconBox = document.createElement('div'); iconBox.style.width='24px'; iconBox.textContent = icon;
      d.append(iconBox, line);
      wrap.appendChild(d);
    });
    $('exportBtn').disabled = rows.length===0;
  }

  // ---- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–µ–∫ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ 2–ì–ò–° ----
  async function checkPoints() {
    const lines = $('coords').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const results = [];
    $('checkBtn').disabled = true;
    $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä—è—é‚Ä¶';

    if (!proxyUrl) {
      alert('–ó–∞–ø–æ–ª–Ω–∏ URL –ø—Ä–æ–∫—Å–∏ 2–ì–ò–° –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.');
      $('checkBtn').disabled = false; $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
      return;
    }

    try {
      for (let i=0; i<lines.length; i++) {
        const raw = lines[i];
        const pt = parsePoint(raw);
        if (!pt) { results.push({ index:i, line:raw, status:'error', details:'–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã' }); continue; }
        const { lat, lon } = pt;

        let minDist = Infinity; let nearest;
        let lastHttpError = null;

        const activeCats = DEFAULT_CATEGORIES.filter(c=>enabledKeys.includes(c.key));
        for (const cat of activeCats) {
          for (const q of cat.queries) {
            try {
              const payload = { q, point: { lat, lon }, radius, page_size: 25, sort: 'distance' };
              const resp = await fetch(proxyUrl, {
                method:'POST',
                headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) {
                lastHttpError = `HTTP ${resp.status}`;
                // –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–µ—Å—Ç—å —Ç–µ–ª–æ
                try {
                  const err = await resp.json();
                  if (err?.error) lastHttpError += ` ‚Äî ${err.error}`;
                } catch {}
                // –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –¥—Ä—É–≥–∞—è —Ñ—Ä–∞–∑–∞ q –≤–µ—Ä–Ω—ë—Ç –æ—Ç–≤–µ—Ç
              } else {
                const data = await resp.json();
                const items = data?.items || data?.result?.items || [];
                // –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç ‚Äî —ç—Ç–æ –ù–û–†–ú–ê (OK), –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –¥—Ä—É–≥–∏–º q –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                for (const it of items) {
                  const p = it?.point || it?.geometry?.centroid || it?.centroid;
                  const ilon = p?.lon ?? p?.lng ?? p?.lonLat?.[0];
                  const ilat = p?.lat ?? p?.latLng ?? p?.lonLat?.[1];
                  if (ilat==null || ilon==null) continue;
                  const d = haversineMeters(lat, lon, ilat, ilon);
                  if (d < minDist) {
                    minDist = d;
                    const name = it?.name || it?.caption || it?.address_name || it?.full_name;
                    const rubric = it?.rubrics && it.rubrics[0]?.name;
                    nearest = name ? (name + (rubric ? ` (${rubric})` : '')) : undefined;
                  }
                }
              }
            } catch (e) {
              // —Å–µ—Ç–µ–≤–æ–π —Å–±–æ–π ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –ø–∞–¥–∞–µ–º
              if (!lastHttpError) lastHttpError = 'NETWORK_ERROR';
            }

            // —â–∞–¥–∏–º –ª–∏–º–∏—Ç—ã ‚Äî –º–∏–∫—Ä–æ–ø–∞—É–∑a
            await sleep(60);

            if (minDist <= radius) break;
          }
          if (minDist <= radius) break;
        }

        // –†–µ—à–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä–æ–∫–µ:
        if (!isFinite(minDist)) {
          // –ù–∏ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∏—á–µ–≥–æ –Ω–µ –≤–µ—Ä–Ω—É–ª/–≤—Å–µ –ø—É—Å—Ç–æ -> —ç—Ç–æ OK (–Ω–∏—á–µ–≥–æ –æ–ø–∞—Å–Ω–æ–≥–æ —Ä—è–¥–æ–º)
          // –ï—Å–ª–∏ –ø—Ä–∏ —ç—Ç–æ–º –±—ã–ª–∏ —è–≤–Ω—ã–µ HTTP-–æ—à–∏–±–∫–∏ ‚Äî –ø–æ–∫–∞–∂–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É-–æ—à–∏–±–∫—É.
          if (lastHttpError) {
            results.push({ index:i, line:raw, status:'error', details:lastHttpError });
          } else {
            results.push({ index:i, line:raw, status:'ok' });
          }
        } else if (minDist <= radius) {
          results.push({ index:i, line:raw, status:'bad', nearest, minDist });
        } else {
          results.push({ index:i, line:raw, status:'ok', nearest, minDist });
        }
      }
    } finally {
      $('checkBtn').disabled = false;
      $('checkBtn').textContent = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
    }

    results.sort((a,b)=>a.index-b.index);
    showResults(results);
  }

  // ---- –≠–∫—Å–ø–æ—Ä—Ç CSV ----
  function exportCSV() {
    if (!rows.length) return;
    const header = 'index,line,status,minDist,nearest\n';
    const body = rows.map(r => [
      r.index,
      `"${String(r.line).replaceAll('"','""')}"`,
      r.status,
      r.minDist ?? '',
      r.nearest ? `"${String(r.nearest).replaceAll('"','""')}"` : ''
    ].join(',')).join('\n');
    const csv = header + body;
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'poi_results.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // ---- –ü—Ä–µ—Å–µ—Ç—ã ----
  function savePreset() {
    const name = $('presetName').value.trim(); if (!name) return;
    const preset = { name, radius, enabledKeys };
    presets = [...presets.filter(p=>p.name!==name), preset];
    localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
    renderPresetSelect();
    $('presetSelect').value = name;
    $('presetName').value = '';
  }
  function applyPreset() {
    const name = $('presetSelect').value;
    const p = presets.find(x=>x.name===name); if (!p) return;
    enabledKeys = p.enabledKeys.slice();
    setRadius(p.radius);
    $('radiusSlider').value = String(Math.max(0, RADIUS_STEPS.indexOf(p.radius)));
    renderCats();
  }
  function deletePreset() {
    const name = $('presetSelect').value; if (!name) return;
    presets = presets.filter(p=>p.name!==name);
    localStorage.setItem(LS_PRESETS, JSON.stringify(presets));
    renderPresetSelect();
  }

  // ---- PWA –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ----
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $('installBtn').style.display = 'inline-block';
  });
  $('installBtn').addEventListener('click', async () => {
    if (deferredPrompt) { await deferredPrompt.prompt(); $('installBtn').style.display = 'none'; }
  });

  // ---- –°–ª—É—à–∞—Ç–µ–ª–∏ ----
  $('coords').addEventListener('input', updateCounts);
  $('checkBtn').addEventListener('click', checkPoints);
  $('clearBtn').addEventListener('click', () => { $('coords').value=''; updateCounts(); showResults([]); });
  $('exportBtn').addEventListener('click', exportCSV);
  $('savePreset').addEventListener('click', savePreset);
  $('presetSelect').addEventListener('change', applyPreset);
  $('deletePreset').addEventListener('click', deletePreset);

  $('radiusSlider').addEventListener('input', (e) => {
    const idx = parseInt(e.target.value, 10);
    const r = RADIUS_STEPS[idx] ?? 50;
    setRadius(r);
  });

  $('proxyUrl').addEventListener('input', e => setProxy(e.target.value));

  // ---- –°—Ç–∞—Ä—Ç ----
  loadFromStorage();
  renderCats();
  renderPresetSelect();
  const idx = Math.max(0, RADIUS_STEPS.indexOf(radius));
  $('radiusSlider').value = String(idx);
  setRadius(radius);
  $('proxyUrl').value = proxyUrl;
  setProxy(proxyUrl);
  updateCounts();

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
  }
})();
</script>
</body>
</html>
